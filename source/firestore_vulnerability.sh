#!/usr/bin/env bash

firestorevulnerability() {
    clear
    function fire() {
        banner
        echo -e "   FireStore Vulnerability"
    }
    fire
    echo -e "
  1.Scanning APK Without Authentication
"
    read -p "senpai@tegalsec:~# " select
    if [[ $select == 1 ]]; then

        milf() {
            rm -rf "$filename"
            exit
        }
        read -p "File: " loli

        filename=$(basename -- "$loli")
        extension="${filename##*.}"
        filename="fsp-${filename%.*}"

        if [[ "$extension" == "apk" ]]; then
            echo -e "[!] The specified APK is $loli.\n"

            if apktool d "$loli" -o "$filename" >/dev/null 2>&1; then
                echo -e "[+] Successful decompilation with apktool.\n"
            else
                echo -e "[-] Decompilation failed with apktool."
                milf
            fi

            if ! grep -qi "firebase" "$filename/AndroidManifest.xml"; then
                echo -e "[-] Firebase not found in the AndroidManifest.xml"
                milf
            else
                echo -e "${lh}[+] Firebase found in the AndroidManifest.xml\n"
                if ! projectID=$(grep -i "project_id" "$filename/res/values/strings.xml"); then
                    echo -e "[-] project_id not found in res/values/strings.xml file."
                    milf
                else
                    echo -e "${lh}[+] project_id found in res/values/strings.xml file:"
                    projectID=$(echo "$projectID" | sed -n 's:.*<string name="project_id">\(.*\)</string>.*:\1:pI')
                    echo -e "$projectID\n"
                    matchString="lcom/google/firebase/firestore/FirebaseFirestore"
                    for c in $(grep -hA 2 "$matchString" -irw "$filename"/smali* 2>/dev/null | grep -iv "$matchString" | grep const-string | sed 's/[^"]*"\([^"]*\)".*/\1/' | sort -u | sed 's/Provided data must not be null.//g'); do
                        collections+=("$c")
                    done

                    if [ "${#collections[@]}" -eq 0 ]; then
                        echo -e "[-] No collections found in .smali files."
                        milf
                    else
                        echo -e "${lh}[+] ${#collections[@]} Collection(s) found in .smali files."
                        for c in "${collections[@]}"; do
                            echo "$c"
                        done
                        echo

                        echo -e "[!] IMPORTANT: Consulting collections can have an economic impact on the objective."
                        echo -e "    Firestore has a daily expense depending on the number of operations performed.\n"
                    fi
                fi
            fi
        else
            echo -e "[-] The specified file does not have an .apk extension."
            milf
        fi

    fi
}
